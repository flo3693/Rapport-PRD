\def\fileversion{1.0}
\def\filedate{2001/9/10}
\def\docdate{2001/9/10}
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{polytech/references}[\filedate\space\fileversion\space Polytech document class sub package]
\typeout{Package `polytech references' \fileversion\space<\filedate>}

\newcommand{\polytech@ref@from@chapter@en}[1]{\xspace(Chapter~#1)}
\newcommand{\polytech@ref@from@chapter@fr}[1]{\xspace(Chapitre~#1)}
\newcommand{\polytech@ref@from@appendix@en}[1]{\xspace(Appendix~#1)}
\newcommand{\polytech@ref@from@appendix@fr}[1]{\xspace(Annexe~#1)}

% ATTENTION : le code suivant doit s'executer avant le chargement du package typedref
\zref@newprop{chapter}[-1]{}
\zref@newprop{isappendix}{}
\zref@addprop{main}{chapter}
\zref@addprop{main}{isappendix}

% remove chapter from section, subsection...
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\theequation}{\arabic{equation}}
\renewcommand{\theHequation}{\arabic{equation}}

% get the reference without the chapter part
\newcommand{\shortref}[1]{\polytech@oldref{#1}}

% get the chapter part of the reference
\newcommand{\refchapter}[1]{%
	\zref@def@extract{\polytech@ref@chapter}{#1}{chapter}%
	\zref@def@extract{\polytech@ref@isappendix}{#1}{isappendix}%
	\ifnumequal{\polytech@ref@chapter}{-1}%
  {% no number defined
  }%
  {%
    \ifnumequal{\polytech@ref@chapter}{\thechapter}%
    {% same chapter, keep short numbering
    }%
    {%
      \ifnumequal{\polytech@ref@isappendix}{0}%
      {%
      	\csuse{polytech@ref@from@chapter@\polytech@lang}{\polytech@ref@chapter}%
      }%
      {%
        \csuse{polytech@ref@from@appendix@\polytech@lang}{\polytech@ref@chapter}%
      }%
    }%
    \xspace%
  }%
}

% redefine label to store additional data with zref
\newcommand{\polytech@label}[1]{%
	\ifbool{polytech@ref@unnumberedchapter}{%
		\zref@setcurrent{chapter}{-1}%
	}{%
  	\zref@setcurrent{chapter}{\thechapter}%
	  \ifnumequal{\thechapter}{\arabic{chapter}}%
	  {%
	    \zref@setcurrent{isappendix}{0}%
	  }%
	  {%
	    \zref@setcurrent{isappendix}{1}%
	  }%
	}%
	\polytech@oldlabel{#1}%
  \zlabel{#1}%
}

% boolean used to not include chapter in autoref
\newbool{polytech@ref@nochapter}

\AtBeginDocument{
	\let\polytech@oldref\ref
	\let\polytech@oldautoref\autoref
	\let\polytech@oldlabel\label
	\let\polytech@oldlabel@in@display\label@in@display



	% replace Tableau by Table in caption, correct case
	\def\tableautorefname{Table}
	\def\sectionautorefname{Section}
	\def\appendixautorefname{Appendix}
	\ifbool{polytech@english}{
		\def\chapterautorefname{Chapter}
		\def\appendixautorefname{Appendix}
	}{
		\def\chapterautorefname{Chapitre}
		\def\appendixautorefname{Annexe}
	}

	% hide chapter from part and chapter
	\appto\partautorefname{\global\booltrue{polytech@ref@nochapter}}
	\appto\chapterautorefname{\global\booltrue{polytech@ref@nochapter}}
	\appto\appendixautorefname{\global\booltrue{polytech@ref@nochapter}}


	% replace standard \ref command
	\renewcommand{\ref}[1]{\shortref{#1}\refchapter{#1}}
	% complete autoref with the chapter part
	\renewcommand{\autoref}[1]{%
		\boolfalse{polytech@ref@nochapter}%
		\polytech@oldautoref{#1}\relax%
		\ifbool{polytech@ref@nochapter}{}{\refchapter{#1}}%
	}
	% replace standard \label command
	\renewcommand{\label}[1]{\polytech@label{#1}}

	% amsmath replace label in equation, so we patch the replacement :)
	\renewcommand{\label@in@display}[1]{\polytech@oldlabel@in@display{#1}\relax\polytech@label{#1}}

	% patch \eqref to move the chapter part outside the parenthesis
	\renewcommand{\eqref}[1]{\textup{\tagform@{\polytech@oldref{#1}}}\refchapter{#1}}
}

